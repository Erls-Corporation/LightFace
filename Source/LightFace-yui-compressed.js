/*
	Inspired by Bert Ramaker's Facebox for jQuery and MooTools:  http://bertramakers.com/labs/
	Rewritten and optimized by David Walsh:  http://davidwalsh.name
*/
/*
---
description:     LightFace

authors:
  - David Walsh (http://davidwalsh.name)

license:
  - MIT-style license

requires:
  core/1.2.1:   '*'

provides:
  - LightFace
  - LightFace.IFrame
  - LightFace.Image
  - LightFace.Request
...
*/

var LightFace=new Class({Implements:[Options,Events],options:{width:"auto",height:"auto",draggable:false,title:"",buttons:[],fadeDelay:150,fadeDuration:150,keys:{esc:function(){this.close()}},content:"<p>Message not specified.</p>",zIndex:9001,pad:100,overlayTitle:false,constrain:false,errorMessage:"<p>The requested file could not be found.</p>"},initialize:function(a){this.setOptions(a);this.state=false;this.buttons={};this.resizeOnOpen=true;this.draw()},draw:function(){this.box=new Element("table",{"class":"lightface",styles:{position:"absolute","z-index":this.options.zIndex,opacity:0},morph:{duration:this.options.fadeDuration}}).inject(document.body,"bottom");var h=["top","center","bottom"],e=["Left","Center","Right"],c=h.length;for(var b=0;b<c;b++){var f=this.box.insertRow(b);for(var g=0;g<c;g++){var d=h[b]+e[g],a=f.insertCell(g);a.className=d;document.id(a).setStyle("opacity",0.4);if(d=="centerCenter"){this.contentBox=new Element("div",{"class":"lightfaceContent",styles:{width:this.options.width}});document.id(a).setStyle("opacity",1).appendChild(this.contentBox)}}}if(this.options.title){this.title=new Element("h2",{"class":"lightfaceTitle",html:this.options.title}).inject(this.contentBox);if(this.options.draggable&&$defined(window.Drag)&&$defined(window["Drag.Move"])){new Drag.Move(this.box,{handle:this.title});this.title.addClass("lightfaceDraggable")}}this.messageBox=new Element("div",{"class":"lightfaceMessageBox",html:(this.options.content||""),styles:{height:this.options.height}}).inject(this.contentBox);this.overlay=new Element("div",{html:"&nbsp;",styles:{opacity:0},"class":"lightfaceOverlay",tween:{link:"chain",duration:this.options.fadeDuration}}).inject(this.contentBox);if(!this.options.overlayTitle){this.overlay.setStyle("top",this.title.getSize().y)}this.footer=new Element("div",{"class":"lightfaceFooter",styles:{display:"none"}}).inject(this.contentBox);if(this.options.buttons.length){this.options.buttons.each(function(i){this.addButton(i.title,i.event,i.submit)},this)}return this},addButton:function(c,a,b){this.footer.setStyle("display","block");this.buttons[c]=(new Element("input",{type:"button",value:c,"class":b?"lightfaceSubmit":"",events:{click:(a||this.close).bind(this)}}).inject(this.footer));return this},showButton:function(a){if(this.buttons[a]){this.buttons[a].removeClass("hiddenButton")}return this.buttons[a]},hideButton:function(a){if(this.buttons[a]){this.buttons[a].addClass("hiddenButton")}return this.buttons[a]},close:function(a){if(this.isOpen){this.box[a?"setStyle":"tween"]("opacity",0);this.fireEvent("close");this._detachEvents();this.isOpen=false}return this},open:function(a){if(!this.isOpen){this.box[a?"setStyle":"tween"]("opacity",1);if(this.resizeOnOpen){this._resize()}this.fireEvent("open");this._attachEvents();this.box.setAttribute("tabIndex",0);(function(){this.box.focus()}).bind(this).delay(100);this.isOpen=true}return this},fade:function(a){this.overlay.setStyle("opacity",a||1);this.fireEvent("fade");return this},unfade:function(){(function(){this.overlay.fade(0)}.bind(this)).delay(this.options.fadeDelay);this.fireEvent("unfade");return this},load:function(a,b){if(a){this.messageBox.set("html",a)}if(b){this.title.set("html",b)}this.fireEvent("complete");return this},_attachEvents:function(){this.keyEvent=function(a){if(this.options.keys[a.key]){this.options.keys[a.key].call(this)}}.bind(this);document.addEvent("keyup",this.keyEvent);this.resizeEvent=this.options.constrain?function(){this._resize()}.bind(this):function(){this._position()}.bind(this);window.addEvent("resize",this.resizeEvent);return this},_detachEvents:function(){document.removeEvent("keyup",this.keyEvent);window.removeEvent("resize",this.resizeEvent);return this},_position:function(){var a=window.getSize(),b=window.getScroll(),c=this.box.getSize();this.box.setStyles({left:b.x+((a.x-c.x)/2),top:b.y+((a.y-c.y)/2)});return this},_resize:function(){var b=this.options.height;if(b=="auto"){var a=window.getSize().y-this.options.pad;if(this.contentBox.getSize().y>a){b=a}}this.messageBox.setStyle("height",b);this._position()},toElement:function(){return this.messageBox},destroy:function(){this._detachEvents();this.box.dispose()}});LightFace.IFrame=new Class({options:{url:""},Extends:LightFace,initialize:function(a){this.parent(a);if(this.options.url){this.load()}},load:function(a,b){this.fade();if(!this.iframe){this.messageBox.set("html","");this.iframe=new IFrame({styles:{width:"100%",height:"100%"},events:{load:function(){this.unfade();this.fireEvent("complete")}.bind(this)},border:0}).inject(this.messageBox);this.messageBox.setStyles({padding:0,overflow:"hidden"})}if(b){this.title.set("html",b)}this.iframe.src=a||this.options.url;this.fireEvent("request");return this}});LightFace.Image=new Class({options:{constrain:true,url:""},Extends:LightFace,initialize:function(a){this.parent(a);this.url="";this.resizeOnOpen=false;if(this.options.url){this.load()}},_resize:function(){var b=window.getSize().y-this.options.pad;var a=document.id(this.image).retrieve("dimensions");if(a.y>b){this.image.height=b;this.image.width=(a.x*(b/a.y))}this.messageBox.setStyles({height:"",width:""});this.position()},load:function(a,c){var b={x:"",y:""};if(this.image){b=this.image.getSize()}this.messageBox.set("html","").setStyles({padding:0,overflow:"hidden",width:b.x,height:b.y});this.position();this.fade();this.image=new Element("img",{events:{load:function(){(function(){this.image.inject(this.messageBox);this.image.store("dimensions",this.image.getSize());this._resize();this.unfade();this.fireEvent("complete")}).bind(this).delay(10)}.bind(this),error:function(){}},styles:{display:"block"}});this.image.src=a||this.options.url;if(c){this.title.set("html",c)}return this}});LightFace.Request=new Class({options:{url:"",request:{url:false}},Extends:LightFace,initialize:function(a){this.parent(a);if(this.options.url){this.load()}},load:function(a,c){var b=$extend({onRequest:function(){this.fade();this.fireEvent("request")}.bind(this),onSuccess:function(d){this.messageBox.set("html",d);this.fireEvent("success")}.bind(this),onFailure:function(){this.messageBox.set("html",this.options.errorMessage);this.fireEvent("failure")}.bind(this),onComplete:function(){this._resize();this.unfade();this.fireEvent("complete")}.bind(this)},this.options.request);if(c){this.title.set("html",c)}if(!b.url){b.url=a||this.options.url}new Request(b).send();return this}});